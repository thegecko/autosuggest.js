/* @license
 *
 * AutoSuggest.js
 * Version: 0.0.2
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2014 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
(function(global,factory){if(typeof exports==="object"){module.exports=factory()}else if(typeof define==="function"&&define.amd){define(factory)}else{global.AutoSuggest=factory()}})(this,function(){"use strict";function buildElement(type,className,style){var element=document.createElement(type);if(className)element.className=className;for(var item in style){element.style[item]=style[item]}return element}function format(){var regex=/\{([^\}]+)\}/g;var separator=":";var args=[].slice.call(arguments);var text=args.shift();return text.replace(regex,function(m,k){var formatter=k.split(separator);var key=formatter.shift();if(typeof args[key]=="undefined"){return m}var value=args[key];if(formatter[0]){formatter=formatter.join(separator);if(formatter=="n"||formatter=="f"){value=value.toFixed(formatter=="f"?2:0)}}return value})}var AutoSuggest=function(element,template,callback){var options=this.options={delimiter:" ",firstDelimiter:false,watermark:"enter something...",multipleMarker:"*",valueFormat:"{0}{1}",descriptionFormat:"{0} ({1})"};for(var item in template){if(options[item]!==undefined){options[item]=template[item]}}this.template=this.currentItem=template;this.references=template.references;this.callback=callback;this.dropdownIndex=0;this.remainingText="";this.suggestItems={};this.freeTextItem=null;this.nodeList=[];var input=this.input=buildElement("input","input",{position:"absolute",backgroundColor:"transparent"});input.addEventListener("focus",this.onFocus.bind(this));input.addEventListener("blur",this.onBlur.bind(this));input.addEventListener("keydown",this.onKeydown.bind(this));input.addEventListener("input",this.onInput.bind(this));var hint=this.hint=buildElement("input","input hint");hint.value=options.watermark;var container=this.container=buildElement("div","suggest");var dropdown=this.dropdown=buildElement("div","dropdown",{position:"absolute",display:"none"});var ruler=this.ruler=buildElement("span","input ruler",{position:"fixed",display:"inline",visibility:"hidden",top:0,right:0,width:"auto"});container.appendChild(ruler);container.appendChild(input);container.appendChild(hint);container.appendChild(dropdown);element.appendChild(container)};AutoSuggest.prototype.textWidth=function(text){this.ruler.innerText=text;return this.ruler.offsetWidth};AutoSuggest.prototype.buildDropdown=function(items){this.dropdown.style.display="none";this.dropdownIndex=0;while(this.dropdown.firstChild){this.dropdown.removeChild(this.dropdown.firstChild)}function onDown(value){return function(){this.setValue(this.input.value+value.substring(this.remainingText.length));setTimeout(function(){this.input.focus()}.bind(this),0)}}if(typeof items==="object"){for(var name in items){var value=items[name];if(this.remainingText&&value.indexOf(this.remainingText)!==0)continue;var item=this.currentItem.items[name];if(!item)continue;var option=buildElement("div","dropdownOption");if(item.items&&item.items["*"]&&item.items["*"].placeHolder){value+=item.items["*"].placeHolder}option.innerText=item.description?format(this.options.descriptionFormat,value,item.description):value;option.addEventListener("mousedown",onDown(value).bind(this));this.dropdown.appendChild(option)}if(this.dropdown.children){var validText=this.input.value.substring(0,this.input.value.length-this.remainingText.length);this.dropdown.style.marginLeft=format("{0}px",this.textWidth(validText));this.dropdown.style.display="block"}}};AutoSuggest.prototype.renderDropdown=function(offset){if(this.dropdown.children){offset=offset||0;this.dropdownIndex+=offset;if(this.dropdownIndex>=this.dropdown.children.length)this.dropdownIndex=0;if(this.dropdownIndex<0)this.dropdownIndex=this.dropdown.children.length-1;for(var i=0;i<this.dropdown.children.length;i++){this.dropdown.children[i].className=i==this.dropdownIndex?"dropdownOption select":"dropdownOption"}}};AutoSuggest.prototype.renderHint=function(){if(this.freeTextItem&&this.freeTextItem.placeHolder){this.hint.value=this.input.value+this.freeTextItem.placeHolder;return}var index=0;for(var name in this.suggestItems){var value=this.suggestItems[name];if(value.indexOf(this.remainingText)===0){if(index==this.dropdownIndex){this.hint.value=this.input.value+value.substring(this.remainingText.length);break}else{index++}}}};AutoSuggest.prototype.parseTemplate=function(remainingText,currentItem,nodeList,multipleParent,ignoreList){nodeList=nodeList||[];ignoreList=ignoreList||[];currentItem=currentItem||this.template;if(currentItem.reference){currentItem=this.references[currentItem.reference]}var freeTextItem=currentItem.items&&currentItem.items[this.options.multipleMarker];var isMultiple=multipleParent&&(freeTextItem||!currentItem.items);var items={};if(!currentItem.items&&multipleParent){currentItem=multipleParent}if(freeTextItem&&multipleParent){items=multipleParent.items}else if(!freeTextItem){items=currentItem.items}var suggestItems={};for(var name in items){var item=items[name];if(isMultiple&&(ignoreList.indexOf(name)>-1||!item.allowOthers))continue;var delimiter=this.options.delimiter;if(nodeList.length===0&&!this.options.firstDelimiter){delimiter=""}else if(isMultiple&&item.multiDelimiter!==undefined)delimiter=item.multiDelimiter;else if(item.delimiter!==undefined)delimiter=item.delimiter;var suffix="";if(item.items&&item.items[this.options.multipleMarker]){if(item.items[this.options.multipleMarker].delimiter!=undefined){suffix=item.items[this.options.multipleMarker].delimiter}else{suffix=this.options.delimiter}}suggestItems[name]=format(this.options.valueFormat,delimiter,name+suffix,item.description)}if(suggestItems!=={}&&remainingText!==""){var matchName=null;var length=-1;if(freeTextItem){matchName=this.options.multipleMarker;length=remainingText.length;for(var name in suggestItems){var value=suggestItems[name];var index=remainingText.indexOf(value);if(index>-1&&index<length){length=index}}if(length===remainingText.length){for(var name in suggestItems){var value=suggestItems[name];for(var i=1;i<=value.length;i++){var partial=value.substring(0,i);var index=remainingText.length-i;if(remainingText.substring(index)===partial&&index<length){length=index}}}}}else{for(var name in suggestItems){var value=suggestItems[name];if(remainingText.indexOf(value)===0&&value.length>length){matchName=name;length=value.length}}}if(matchName){if(currentItem.items[matchName].allowOthers){ignoreList.push(matchName);multipleParent=multipleParent||currentItem}var node=matchName===this.options.multipleMarker?remainingText.substring(0,length):matchName;nodeList.push(node);return this.parseTemplate(remainingText.substring(length),currentItem.items[matchName],nodeList,multipleParent,ignoreList)}}this.currentItem=currentItem;this.remainingText=remainingText;this.suggestItems=suggestItems;this.freeTextItem=freeTextItem;this.nodeList=nodeList};AutoSuggest.prototype.render=function(){this.hint.value="";this.parseTemplate(this.input.value);if(this.input===document.activeElement){this.buildDropdown(this.suggestItems);this.renderDropdown();this.renderHint()}};AutoSuggest.prototype.onFocus=function(){this.render()};AutoSuggest.prototype.onBlur=function(){this.buildDropdown(null);this.hint.value=this.input.value===""?this.options.watermark:this.input.value};AutoSuggest.prototype.onKeydown=function(e){e=e||window.event;var keyCode=e.keyCode;switch(keyCode){case 9:case 13:case 39:{if(this.input.selectionStart==this.input.value.length&&this.input.selectionStart<this.hint.value.length){this.setValue(this.hint.value)}if(keyCode===9){e.preventDefault();e.stopPropagation()}break}case 27:{this.buildDropdown(null);break}case 38:case 40:{this.renderDropdown(keyCode==38?-1:1);this.renderHint();e.preventDefault();e.stopPropagation();break}}};AutoSuggest.prototype.onInput=function(){this.render();this.callback(this.input.value,this.nodeList,this.currentItem)};AutoSuggest.prototype.setValue=function(value){this.input.value=value;this.onInput()};return AutoSuggest});