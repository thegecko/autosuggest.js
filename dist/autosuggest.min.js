/* @license
 *
 * AutoSuggest.js
 * Version: 0.0.8
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2014 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
(function(global,factory){if(typeof exports==="object"){module.exports=factory()}else if(typeof define==="function"&&define.amd){define(factory)}else{global.AutoSuggest=factory()}})(this,function(){"use strict";function buildElement(type,className,style){var element=document.createElement(type);if(className)element.className=className;for(var item in style){element.style[item]=style[item]}return element}function format(){var regex=/\{([^\}]+)\}/g;var separator=":";var args=[].slice.call(arguments);var text=args.shift();return text.replace(regex,function(m,k){var formatter=k.split(separator);var key=formatter.shift();if(typeof args[key]=="undefined"){return m}var value=args[key];if(formatter[0]){formatter=formatter.join(separator);if(formatter=="n"||formatter=="f"){value=value.toFixed(formatter=="f"?2:0)}}return value})}var AutoSuggest=function(element,template,callback){var options=this.options={watermark:"enter text...",prefill:false,delimiter:" ",firstDelimiter:false,valueFormat:"{0}{1}",descriptionFormat:"{0} ({1})",freeTextMarker:"*",referenceMarker:"$ref",inputClass:"input",hintClass:"input hint",containerClass:"suggest",dropdownClass:"dropdown",dropdownOptionClass:"dropdownOption",dropdownSelectClass:"dropdownOption select",rulerClass:"input ruler",loaderClass:"loader"};for(var item in template){if(options[item]!==undefined){options[item]=template[item]}}this.template=template;this.references=template.references;this.callback=callback;this.dropdownIndex=0;this.freeTextItem=null;this.state={};var input=this.input=buildElement("input",options.inputClass,{position:"absolute",display:"block",backgroundColor:"transparent",width:"100%"});input.type="text";input.addEventListener("keydown",this.onKeydown.bind(this));input.addEventListener("input",this.onInput.bind(this));input.addEventListener("focus",this.onFocus.bind(this));input.addEventListener("blur",this.onBlur.bind(this));var hint=this.hint=buildElement("input",options.hintClass,{display:"block",width:"100%"});hint.type="text";hint.disabled=true;var container=this.container=buildElement("div",options.containerClass,{position:"relative"});var dropdown=this.dropdown=buildElement("div",options.dropdownClass,{position:"absolute",zIndex:1e3,display:"none"});var ruler=this.ruler=buildElement("span",options.rulerClass,{position:"fixed",display:"inline",visibility:"hidden",top:0,right:0,width:"auto"});var loader=this.loader=buildElement("div",options.loaderClass,{position:"absolute",right:"0",visibility:"hidden"});if(options.prefill){for(var name in template.items)break;input.value=this.itemValue(template.items[name],name)}else{hint.value=options.watermark}container.appendChild(ruler);container.appendChild(input);container.appendChild(loader);container.appendChild(hint);container.appendChild(dropdown);element.appendChild(container);this.parseTemplate(this.input.value)};AutoSuggest.prototype.itemValue=function(item,name){var value=item.value||name;if(item.items&&item.items[this.options.freeTextMarker]){var suffixItem=item.items[this.options.freeTextMarker];value+=suffixItem.delimiter||this.options.delimiter}return value};AutoSuggest.prototype.resolveReference=function(item){if(item[this.options.referenceMarker]){var referenceName=item[this.options.referenceMarker];var reference=this.references[referenceName];for(var name in reference){if(item[name]===undefined){item[name]=reference[name]}}}};AutoSuggest.prototype.parseTemplate=function(remainingText,currentItem,nodeList,multipleParent,ignoreList){currentItem=currentItem||this.template;nodeList=nodeList||[];ignoreList=ignoreList||[];this.resolveReference(currentItem);this.loader.style.visibility="visible";var itemFn=currentItem.itemFn||function(state,callback){callback()};itemFn({text:this.input.value.substring(remainingText.length),item:currentItem,list:nodeList},function(){this.loader.style.visibility="hidden";var freeTextItem=currentItem.items&&currentItem.items[this.options.freeTextMarker];var isMultiple=multipleParent&&(freeTextItem||!currentItem.items);var items={};if(freeTextItem&&multipleParent){items=multipleParent.items}else if(!freeTextItem){items=currentItem.items||multipleParent&&multipleParent.items||{}}var suggestItems={};for(var name in items){var item=items[name];this.resolveReference(item);if(isMultiple&&(ignoreList.indexOf(name)>-1||!item.allowOthers))continue;var delimiter=this.options.delimiter;if(nodeList.length===0&&!this.options.firstDelimiter){delimiter=""}else if(isMultiple&&item.multiDelimiter!==undefined){delimiter=item.multiDelimiter}else if(item.delimiter!==undefined){delimiter=item.delimiter}suggestItems[name]=format(this.options.valueFormat,delimiter,this.itemValue(item,name),item.description)}if(suggestItems!=={}&&remainingText!==""){var matchName=null;var length=-1;if(freeTextItem){matchName=this.options.freeTextMarker;length=remainingText.length;for(var name in suggestItems){var value=suggestItems[name];var index=remainingText.indexOf(value);if(index>-1&&index<length){length=index}}if(length===remainingText.length){for(var name in suggestItems){var value=suggestItems[name];for(var i=1;i<=value.length;i++){var partial=value.substring(0,i);var index=remainingText.length-i;if(remainingText.substring(index)===partial&&index<length){length=index}}}}}else{for(var name in suggestItems){var value=suggestItems[name];if(remainingText.indexOf(value)===0&&value.length>length){matchName=name;length=value.length}}}if(matchName){if(!currentItem.items&&multipleParent){currentItem=multipleParent}if(currentItem.items[matchName].allowOthers){ignoreList.push(matchName);multipleParent=multipleParent||currentItem}var node=matchName===this.options.freeTextMarker?remainingText.substring(0,length):matchName;nodeList.push(node);return this.parseTemplate(remainingText.substring(length),currentItem.items[matchName],nodeList,multipleParent,ignoreList)}}var descriptions={};for(var name in suggestItems){var value=suggestItems[name];var item=items[name];var description=item.description?format(this.options.descriptionFormat,value,item.description):value;descriptions[name]=description}this.freeTextItem=freeTextItem;this.state={remainingText:remainingText,template:currentItem,list:nodeList,items:suggestItems,descriptions:descriptions};this.onParse()}.bind(this))};AutoSuggest.prototype.textWidth=function(text){this.ruler.innerText=text;return this.ruler.offsetWidth};AutoSuggest.prototype.buildDropdown=function(state){this.dropdown.style.display="none";this.dropdownIndex=0;while(this.dropdown.firstChild){this.dropdown.removeChild(this.dropdown.firstChild)}function onDown(value){return function(){this.setValue(this.input.value+value.substring(state.remainingText.length));setTimeout(function(){this.input.focus()}.bind(this),0)}}if(state){for(var name in state.items){var value=state.items[name];if(state.remainingText&&value.indexOf(state.remainingText)!==0)continue;var option=buildElement("div",this.options.dropdownOptionClass);option.innerText=state.descriptions[name];option.addEventListener("mousedown",onDown(value).bind(this));this.dropdown.appendChild(option)}if(this.dropdown.children){this.dropdown.style.display="block";var validText=this.input.value.substring(0,this.input.value.length-state.remainingText.length);var offset=Math.min(this.textWidth(validText),this.input.clientWidth-this.dropdown.clientWidth);this.dropdown.style.marginLeft=format("{0}px",offset)}}};AutoSuggest.prototype.renderDropdown=function(offset){if(this.dropdown.children){offset=offset||0;this.dropdownIndex+=offset;if(this.dropdownIndex>=this.dropdown.children.length)this.dropdownIndex=0;if(this.dropdownIndex<0)this.dropdownIndex=this.dropdown.children.length-1;for(var i=0;i<this.dropdown.children.length;i++){this.dropdown.children[i].className=i==this.dropdownIndex?this.options.dropdownSelectClass:this.options.dropdownOptionClass}}};AutoSuggest.prototype.renderHint=function(state){if(this.freeTextItem&&this.freeTextItem.placeHolder){this.hint.value=this.input.value+this.freeTextItem.placeHolder;return}var index=0;for(var name in state.items){var value=state.items[name];if(value.indexOf(state.remainingText)===0){if(index==this.dropdownIndex){this.hint.value=this.input.value+value.substring(state.remainingText.length);break}else{index++}}}};AutoSuggest.prototype.onKeydown=function(e){e=e||window.event;var keyCode=e.keyCode;switch(keyCode){case 9:case 13:case 39:{if(this.input.selectionStart==this.input.value.length&&this.input.selectionStart<this.hint.value.length){this.setValue(this.hint.value)}if(keyCode===9){e.preventDefault();e.stopPropagation()}break}case 27:{this.buildDropdown();break}case 38:case 40:{this.renderDropdown(keyCode==38?-1:1);this.renderHint(this.state);e.preventDefault();e.stopPropagation();break}}};AutoSuggest.prototype.onInput=function(){this.hint.value="";this.parseTemplate(this.input.value)};AutoSuggest.prototype.onFocus=function(){this.render()};AutoSuggest.prototype.onBlur=function(){this.buildDropdown();this.hint.value=this.input.value===""?this.options.watermark:""};AutoSuggest.prototype.onParse=function(){this.render();this.callback(this.input.value,this.state)};AutoSuggest.prototype.render=function(){if(this.input===document.activeElement){this.buildDropdown(this.state);this.renderDropdown();this.renderHint(this.state);setTimeout(function(){this.hint.scrollLeft=this.input.scrollLeft}.bind(this),0)}};AutoSuggest.prototype.setValue=function(value){this.input.value=value;this.onInput()};return AutoSuggest});