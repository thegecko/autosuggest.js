/* @license
 *
 * AutoSuggest.js
 * Version: 0.0.17
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2015 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define(b):a.AutoSuggest=b()}(this,function(){"use strict";function a(a,b,c){var d=document.createElement(a);b&&(d.className=b);for(var e in c)d.style[e]=c[e];return d}function b(){var a=/\{([^\}]+)\}/g,b=":",c=[].slice.call(arguments),d=c.shift();return d.replace(a,function(a,d){var e=d.split(b),f=e.shift();if("undefined"==typeof c[f])return a;var g=c[f];return e[0]&&(e=e.join(b),("n"==e||"f"==e)&&(g=g.toFixed("f"==e?2:0))),g})}var c=function(b,c,d){var e=this.options={watermark:"enter text...",prefill:!1,delimiter:" ",firstDelimiter:!1,valueFormat:"{0}{1}",descriptionFormat:"{0} ({1})",freeTextMarker:"*",parseOnFocus:!1,paddingRight:40,inputClass:"input",hintClass:"input hint",containerClass:"suggest",dropdownClass:"dropdown",dropdownOptionClass:"dropdownOption",dropdownSelectClass:"dropdownOption select",rulerClass:"input ruler",loaderClass:"loader"};for(var f in c)void 0!==e[f]&&(e[f]=c[f]);this.template=c,this.callback=d,this.dropdownIndex=-1,this.freeTextItem=null,this.state={},this.cachedPaths=[];var g=this.input=a("input",e.inputClass,{position:"absolute",display:"block",backgroundColor:"transparent",width:"100%"});g.type="text",g.addEventListener("keydown",this.onKeydown.bind(this)),g.addEventListener("input",this.onInput.bind(this)),g.addEventListener("focus",this.onFocus.bind(this)),g.addEventListener("blur",this.onBlur.bind(this));var h=this.hint=a("input",e.hintClass,{display:"block",width:"100%"});h.type="text";var i=this.container=a("div",e.containerClass,{position:"relative"}),j=this.dropdown=a("div",e.dropdownClass,{position:"absolute",zIndex:1e3,display:"none"}),k=this.ruler=a("span",e.rulerClass,{position:"fixed",display:"inline",visibility:"hidden",top:0,right:0,width:"auto"}),l=this.loader=a("div",e.loaderClass,{position:"absolute",right:"0",visibility:"hidden"});if(e.prefill)if("string"==typeof e.prefill)g.value=e.prefill;else{for(var m in c.items)break;g.value=this.itemValue(c.items[m],m)}else h.value=e.watermark;i.appendChild(k),i.appendChild(g),i.appendChild(l),i.appendChild(h),i.appendChild(j),b.appendChild(i),this.parseTemplate(this.input.value)};return c.prototype.itemValue=function(a,b){var c=a.value||b;if(a.items&&a.items[this.options.freeTextMarker]){var d=a.items[this.options.freeTextMarker];c+=d.delimiter||this.options.delimiter}return c},c.prototype.resolveReference=function(a){if(a.$ref&&0===a.$ref.indexOf("#")){var b=a.$ref.split(/[#\/]+/).splice(1),c=this.template;for(var d in b)if(c=c[b[d]],!c)return;for(var e in c)void 0===a[e]&&(a[e]=c[e])}},c.prototype.parseTemplate=function(a,c,d,e,f){c=c||this.template,d=d||[],f=f||[],this.resolveReference(c),this.loader.style.visibility="visible";var g=function(a,b){b()},h=this.input.value.substring(0,this.input.value.length-a.length);c.itemFn&&this.cachedPaths.indexOf(h)<0&&(g=c.itemFn,this.cachedPaths.push(h)),g({matchedText:h,remainingText:a,item:c,list:d},function(){this.loader.style.visibility="hidden";var g=c.items&&c.items[this.options.freeTextMarker],i=e&&(g||!c.items),j={};g&&e?j=e.items:g||(j=c.items||e&&e.items||{});var k={};for(var l in j){var m=j[l];if(this.resolveReference(m),!i||!(f.indexOf(l)>-1)&&m.allowOthers){var n=this.options.delimiter;0!==d.length||this.options.firstDelimiter?i&&void 0!==m.multiDelimiter?n=m.multiDelimiter:void 0!==m.delimiter&&(n=m.delimiter):n="",k[l]=b(this.options.valueFormat,n,this.itemValue(m,l),m.description)}}if(k!=={}&&""!==a){var o=null,p=-1;if(g){o=this.options.freeTextMarker,p=a.length;for(l in k){var q=k[l],r=a.indexOf(q);r>-1&&p>r&&(p=r)}if(p===a.length)for(l in k){q=k[l];for(var s=1;s<=q.length;s++){var t=q.substring(0,s);r=a.length-s,a.substring(r)===t&&p>r&&(p=r)}}}else for(l in k)q=k[l],0===a.indexOf(q)&&q.length>p&&(o=l,p=q.length);if(o){!c.items&&e&&(c=e),c.items[o].allowOthers&&(f.push(o),e=e||c);var u=o===this.options.freeTextMarker?a.substring(0,p):o;return d.push(u),this.parseTemplate(a.substring(p),c.items[o],d,e,f)}}var v={};for(l in k){q=k[l],m=j[l];var w=m.description?b(this.options.descriptionFormat,q,m.description):q;v[l]=w}this.freeTextItem=g,this.state={matchedText:h,remainingText:a,item:c,list:d,items:k,descriptions:v},this.onParse()}.bind(this))},c.prototype.textWidth=function(a){return this.ruler.textContent=a,this.ruler.offsetWidth},c.prototype.buildDropdown=function(c){function d(a){return function(){this.setValue(this.input.value+a.substring(c.remainingText.length)),setTimeout(function(){this.input.focus()}.bind(this),0)}}for(this.dropdown.style.display="none",this.dropdown.style.marginLeft=0,this.dropdownIndex=-1;this.dropdown.firstChild;)this.dropdown.removeChild(this.dropdown.firstChild);if(c){for(var e in c.items){var f=c.items[e];if(!c.remainingText||0===f.indexOf(c.remainingText)){var g=a("div",this.options.dropdownOptionClass);g.textContent=c.descriptions[e],g.addEventListener("mousedown",d(f).bind(this)),this.dropdown.appendChild(g)}}if(this.dropdown.children&&this.dropdown.children.length>0){this.dropdownIndex=0,this.dropdown.style.display="block";var h=this.textWidth(c.matchedText)-this.input.scrollLeft,i=Math.min(h,this.input.clientWidth-this.dropdown.clientWidth);this.dropdown.style.marginLeft=b("{0}px",i)}}},c.prototype.renderDropdown=function(a){if(this.dropdownIndex>=0){a=a||0,this.dropdownIndex+=a,this.dropdownIndex>=this.dropdown.children.length&&(this.dropdownIndex=0),this.dropdownIndex<0&&(this.dropdownIndex=this.dropdown.children.length-1);for(var b=0;b<this.dropdown.children.length;b++)this.dropdown.children[b].className=b==this.dropdownIndex?this.options.dropdownSelectClass:this.options.dropdownOptionClass}},c.prototype.selectedValue=function(a){var b=0;for(var c in a.items){var d=a.items[c];if(0===d.indexOf(a.remainingText)){if(b==this.dropdownIndex)return d.substring(a.remainingText.length);b++}}return""},c.prototype.renderHint=function(a){var c=this.textWidth(this.input.value)+parseInt(getComputedStyle(this.input,null).getPropertyValue("padding-left")),d=Math.min(c,this.hint.clientWidth-this.options.paddingRight);return this.hint.style.paddingLeft=b("{0}px",d),this.freeTextItem&&this.freeTextItem.placeHolder?void(this.hint.value=this.freeTextItem.placeHolder):void(this.hint.value=this.selectedValue(a))},c.prototype.onKeydown=function(a){a=a||window.event;var b=a.keyCode;switch(b){case 9:case 13:case 39:this.input.selectionStart==this.input.value.length&&this.dropdownIndex>=0&&this.setValue(this.input.value+this.selectedValue(this.state)),9===b&&(a.preventDefault(),a.stopPropagation());break;case 27:this.buildDropdown();break;case 38:case 40:this.renderDropdown(38==b?-1:1),this.renderHint(this.state),a.preventDefault(),a.stopPropagation()}},c.prototype.onInput=function(){this.hint.value="",this.parseTemplate(this.input.value)},c.prototype.onFocus=function(){this.input.style.paddingRight=b("{0}px",this.options.paddingRight),this.options.parseOnFocus?this.onInput():this.render()},c.prototype.onBlur=function(){this.input.style.paddingRight="",this.buildDropdown(),this.hint.value=""===this.input.value?this.options.watermark:"",this.cachedPaths=[]},c.prototype.onParse=function(){this.render(),this.callback(this.input.value,this.state)},c.prototype.render=function(){this.input===document.activeElement&&(this.buildDropdown(this.state),this.renderDropdown(),this.renderHint(this.state),this.input.scrollLeft=this.input.scrollWidth)},c.prototype.setValue=function(a){this.input.value=a,this.onInput()},c});